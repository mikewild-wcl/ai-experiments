#trigger: none  # Manual trigger only
trigger:
  branches:
    include:
      - main
  paths:
    include:
      - infrastructure/**

pr: none

name: AI Resource Provisioning Pipeline

parameters:
- name: azureServiceConnection
  type: string
  default: 'az2026connection'

variables:
  vmImageName: 'ubuntu-latest'
  resourceGroupName: 'rg-ai-experiments-resources'
  location: 'uksouth'
  bicepFile: 'infrastructure/bicep/main.bicep'
  #bicepParamFile: 'infrastructure//bicep/main.bicepparam'

pool:
  vmImage: $(vmImageName)

stages:
  - stage: Provision
    displayName: 'Provision dev infrastructure'
    jobs:
    - deployment: Provision
      displayName: 'Provision resources'
      environment: 'dev'
      strategy:
        runOnce:
          deploy:
            steps:

            - checkout: self # Explicit checkout because deployment job won't clone the repo by default

            - task: AzureCLI@2
              displayName: 'az version check'
              inputs:
                azureSubscription: '${{ parameters.azureServiceConnection }}'
                scriptType: bash
                scriptLocation: inlineScript
                useGlobalConfig: false
                inlineScript: |
                  az --version

            # - task: PowerShell@2
            #   displayName: List all Folders in $(System.DefaultWorkingDirectory)
            #   inputs:
            #     targetType: 'inline'
            #     pwsh: true
            #     script: |
            #       Get-ChildItem -path $(System.DefaultWorkingDirectory) -recurse | ForEach-Object { Write-Host $_.FullName }

            - task: AzureCLI@2
              displayName: 'Create resource group $(resourceGroupName)'
              inputs:
                azureSubscription: '${{ parameters.azureServiceConnection }}'
                scriptType: 'bash'
                scriptLocation: 'inlineScript'
                inlineScript: |
                  az group create --name $(resourceGroupName) --location $(location)

            - task: AzureCLI@2
              displayName: 'Deploy bicep template'
              inputs:
                azureSubscription: '${{ parameters.azureServiceConnection }}'
                scriptType: bash
                scriptLocation: inlineScript
                useGlobalConfig: false
                inlineScript: |
                  az deployment group create --resource-group  $(resourceGroupName) --template-file $(bicepFile) 

